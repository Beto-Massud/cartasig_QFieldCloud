* QFieldCloud server
[[./docs/assets/images/logo.png]]
[[https://github.com/opengisch/qfieldcloud/workflows/Deploy%20on%20dev.qfield.cloud/badge.svg]]
[[https://github.com/opengisch/status.qfield.cloud/workflows/dev.qfield.cloud%20APIs%20status/badge.svg]]
[[https://github.com/opengisch/status.qfield.cloud/workflows/app.qfield.cloud%20APIs%20status/badge.svg]]
** Purpose
   QFieldCloud is a service designed to synchronize projects and data
   between QGIS (+ QFieldSync plugin) and QField.

   Initially it will allow to replace the use of the cable to copy
   projects in QField and later it will also allow to synchronize data
   and view and edit projects via web interface.

   *Offline editing mode with desktop synchronization*
   [[./docs/assets/images/offline-schema.png]]

   *Hybrid editing mode with synchronization on the server*
   [[./docs/assets/images/hybrid-schema.png]]
** Development
*** Launch a local instance
    To build development images and run the containers:
    #+begin_src sh
      docker-compose up -d --build
    #+end_src

    It will read =docker-compose.yml= and =.env.dev= and start a
    django built-in server at http://localhost:8000

    To run django commands on the docker, enter in the docker bash or
    place =docker-compose run web= before the command, e.g.:
    #+begin_src sh
      docker-compose run web python manage.py runserver
    #+end_src
*** Code structure
**** Django apps
     The Django code is structured in 3 separate apps. One app for the
     REST API views, one for the data model and one for the views and
     web templates. 

     This structure has been decided to allow, in the future, to
     logically add other apps (e.g. webgis) that refer to the same
     data model and easily remove the web app if we decide to
     implement the web interface externally to Django.

     | Path                         | Description                        |
     |------------------------------+------------------------------------|
     | =.=                          | Repository root                    |
     | =¦-- web-app=                | Root of all the django code        |
     | =¦   ¦--qfieldcloud=         | Django project                     |
     | =¦   ¦   ¦--apps/model=      | Django app with the data model     |
     | =¦   ¦   ¦--apps/api=        | Django app with the REST API views |
     | =¦   ¦   ¦--apps/web=        | Django app with the web views      |
     | =¦   ¦--user_projects_files= | Repository of the users files      |
**** APIs
   The autogenerated REST API documentation is available on http://dev.qfield.cloud/swagger/
   A useful example on how to use the APIs is the [[https://github.com/opengisch/qfieldcloud/blob/master/web-app/qfieldcloud/apps/api/tests/test_functional.py][functional test]]
**** Data model
***** User
      Extends Django's AbstracUser
      | Name      | Type | Req. | Description                    |
      |-----------+------+------+--------------------------------|
      | user_type | int  | t    | Define if user or organization |
***** Organization
      Extends User
      | Name               | Type | Req. | Description |
      |--------------------+------+------+-------------|
      | organization_owner | FK   | t    | FK on User  |
***** Project
      A project represent the repository of the user's files
      A project can have only one QGIS project inside (qgs or qgz)

      | Name        | Type    | Req. | Description                                 |
      |-------------+---------+------+---------------------------------------------|
      | name        | string  | t    | name of the project                         |
      | description | string  |      | short description of the project            |
      | homepage    | string  |      | URL with more information about the project |
      | private     | boolean |      | Default: false                              |
      | owner       | FK      | t    | user / organization                         |
      | created_at  | date    | auto |                                             |
      | updated_ad  | date    | auto |                                             |
***** ProjectCollaborator
      | Name         | Type | Req. | Description   |
      |--------------+------+------+---------------|
      | project      | FK   | t    | FK on Project |
      | Collaborator | FK   | t    | FK on User    |
      | role         | int  | t    |               |

      A collaborator of an normal user project can only be reporter or
      reader. Editor or manager can only be set to an organization's project.
****** Roles
      A higher role always include also the lowest ones

      | Name     | Description                                                                                |
      |----------+--------------------------------------------------------------------------------------------|
      | admin    | The owner of a project is always admin of the project. He can add and remove collaborators |
      | manager  | Can add or remove collaborators                                                            |
      | editor   | Can edit data                                                                              |
      | reporter | Can only insert data (no update nor delete). (Don't have to be a collaborator?)            |
      | reader   | Can read data. (Don't have to be a collaborator?)                                          |
***** OrganizationMember
      | Name         | Type | Req. | Description |
      |--------------+------+------+-------------|
      | organization | FK   | t    | FK on User  |
      | member       | FK   | t    | FK on User  |
      | role         | int  | t    |             |
****** Roles
      A higher role always include also the lowest ones

      | Name    | Description                                                        |
      |---------+--------------------------------------------------------------------|
      | admin   | She can add and remove members and create project                  |
      | member  | (difference compared to an other user is for billing reasons only) |
***** File
      This represent the original file as seen by the client

      | Name          | Type   | Req. | Description                                  |
      |---------------+--------+------+----------------------------------------------|
      | project       | FK     | t    | FK on Project                                |
      | original_path | string | t    | absolute path of the file, filename included |
      | created_at    | date   | auto |                                              |
      | updated_at    | date   | auto |                                              |
***** FileVersion
      This represent the physical file versions stored on the file
      system

      | Name        | Type      | Req. | Description   |
      |-------------+-----------+------+---------------|
      | file        | FK        | t    | FK on File    |
      | stored_file | FileField | t    | physical file |
      | created_at  | date      | auto |               |
      | uploaded_by | FK        | t    | FK on User    |
*** Tests
    To run all the unit and functional tests (on a throwaway test
    database and a throwaway test storage directory):
    #+begin_src sh
      docker-compose run web python manage.py test
    #+end_src
    
    To run only a test module (e.g. `test_permission.py`)
    #+begin_src sh
      docker-compose run web python manage.py test qfieldcloud.apps.api.test_permission
    #+end_src
*** Demo data
    Demo data are loaded with:
    #+begin_src sh
      python manage.py loaddata qfieldcloud/apps/model/fixtures/demo_data.json
    #+end_src

    Initial demo data:
    - superuser
      - username: demo_admin
      - password: demo_pwd
    - normal user
      - username: demo_user
      - password: demo_pwd
    - project
      - project name: demo_project
*** QGIS projects and layer types
    Before exporting a project via QFieldSync to be used in QField, it
    is necessary to assign to each layer an "action" which determines
    how QFieldSync should treat the layer.

    This information is saved within the QGS project as layer's
    =customProperty=, with the =QFieldSync/action= key.

    The possible actions available for the export of a project to be
    loaded in QField without QFieldCloud (for example via cable) are:
    | Action code   | UI name          | File based layer                                                   | Not file based layer                            |
    |---------------+------------------+--------------------------------------------------------------------+-------------------------------------------------|
    | OFFLINE       | Offline editing  | Create a consolidated copy of the affected data with relative path | Create a consolidated copy of the affected data |
    | NO_ACTION     | Copy / No action | Copy data file and make relative path                              | No action on the layer                          |
    | KEEP_EXISTENT | Keep existent    | Keep existing data or do NO_ACTION                                 | N/A                                             |
    | REMOVE        | Remove           | Remove the layer from the project                                  | Remove the layer from the project               |

    When it comes to loading a project into QFieldCloud, one more
    option is offered and this is how QFieldSync behaves with
    individual layers:
    | Action        | UI name      | File based layer                                                   | Not file based layer                                      |
    |---------------+--------------+--------------------------------------------------------------------+-----------------------------------------------------------|
    | OFFLINE       | Consolidate  | Create a consolidated copy of the affected data with relative path | Create a consolidated copy of the affected data           |
    | NO_ACTION     | Live layer   | N/A                                                                | No action on the layer                                    |
    | KEEP_EXISTENT | -            | N/A                                                                | N/A                                                       |
    | REMOVE        | Ignore layer | Remove the layer from the project                                  | Remove the layer from the project                         |
    | HYBRID        | Cloud        | Create a consolidated copy of the data                             | No action (consolidated copies are created on the server) |

    This is the behavior of QFieldCloud with the layers:
    | Action        | File based layer                                                  | Not file based layer                                                                           |
    |---------------+-------------------------------------------------------------------+------------------------------------------------------------------------------------------------|
    | OFFLINE       | Send the file to the client on pull, replace last version on push | N/A (it's alway file based at this point)                                                      |
    | NO_ACTION     | N/A                                                               | No action on the layer                                                                         |
    | KEEP_EXISTENT | N/A                                                               | N/A                                                                                            |
    | REMOVE        | N/A (the layer is no longer there)                                | N/A (the layer is no longer there)                                                             |
    | HYBRID        | Send the consolidated copy on pull, apply delta file on push      | Create consolidated copy of the data on pull, apply delta file on push to original data source |

    This is the behavior of QField with the layers:
    | Action        | File based layer                     | Not file based layer                   |
    |---------------+--------------------------------------+----------------------------------------|
    | OFFLINE       | Edit and push directly the data file | N/A                                    |
    | NO_ACTION     | N/A                                  | Edit the online (live) database        |
    | KEEP_EXISTENT | N/A                                  | N/A                                    |
    | REMOVE        | N/A                                  | N/A                                    |
    | HYBRID        | Create and push deltafile            | N/A (it's alway file based for QField) |

    In summary, for with QFieldCloud:
    - =NO_ACTION= is used for online layers that are located on a server
      accessible via the Internet and that are modified directly by
      QField.
    - =HYBRID= means that a geopackage will be generated on the
      server (or directly on the desktop for file-based layers) and
      downloaded by clients. The client will generate deltafiles of
      the changes.
    - =OFFLINE= is used for example to work with local databases not
      visible by QFieldCloud which are consolidated before being
      loaded from the desktop to the server and are not synchronized
      with the original data by QFieldCloud.
    - =REMOVE= will simply remove the layer from the project.
    - =KEEP_EXISTENT= will not be used for QFieldCloud syncronizations.

    From QFieldSync it will be possible to update a project already
    loaded on QFieldCloud. In the event that the changes concern only
    styles, forms etc. but not the structure of the layers, the
    project on the server will simply be updated.
    If there are changes in the layers structure, the project will be
    reset on the server (delta files will be deleted) and for each
    client it will be necessary to download the updated version of the
    project before being able to push new changes.
** Deployment
*** Servers
    QFieldCloud is published on two servers:
    - https://dev.qfield.cloud/ This is a testing instance for new
      features. Every push into master will be automatically deployed
      on this server via a Github workflow.
    - https://app.qfield.cloud/ This is the production instance. At
      the moment the deploy is done manually.

    On the "dev" server the `docker-compose.dev.yml` is used. On the
    "app" server, the `docker-compose.prod.yml` is used. On the
    servers there are no mounted folders. To apply changes, the docker
    image must be re-build.
*** Infrastructure
   Based on this example
   https://testdriven.io/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/
** Resources
   - [[https://qfield.cloud][QField Cloud "marketing" page]]
   - [[https://app.qfield.cloud/swagger/][API Swagger doc]]
   - [[http://status.qfield.cloud/][API status page]]

