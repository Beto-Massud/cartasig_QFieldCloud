* QFieldCloud server
[[./docs/assets/images/logo.png]]
[[https://github.com/opengisch/qfieldcloud/workflows/Deploy%20on%20dev.qfield.cloud/badge.svg]]
[[https://github.com/opengisch/status.qfield.cloud/workflows/dev.qfield.cloud%20APIs%20status/badge.svg]]
[[https://github.com/opengisch/status.qfield.cloud/workflows/app.qfield.cloud%20APIs%20status/badge.svg]]
** Purpose
   QFieldCloud is a service designed to synchronize projects and data
   between QGIS (+ QFieldSync plugin) and QField.

   Initially it will allow to replace the use of the cable to copy
   projects in QField and later it will also allow to synchronize data
   and view and edit projects via web interface.

   #+CAPTION: Offline editing mode with desktop synchronization
   [[./docs/assets/images/offline-schema.png]]

   #+CAPTION: Hybrid editing mode with synchronization on the server
   [[./docs/assets/images/hybrid-schema.png]]
** Development
*** Launch a local instance
    To build development images and run the containers:
    #+begin_src sh
      docker-compose up -d --build
    #+end_src

    It will read =docker-compose.yml= and =.env.dev= and start a
    django built-in server at http://localhost:8000

    To run django commands on the docker, enter in the docker bash or
    place =docker-compose run web= before the command, e.g.:
    #+begin_src sh
      docker-compose run web python manage.py runserver
    #+end_src
*** Code structure
**** Django apps
     The Django code is structured in 3 separate apps. One app for the
     REST API views, one for the data model and one for the views and
     web templates. 

     This structure has been decided to allow, in the future, to
     logically add other apps (e.g. webgis) that refer to the same
     data model and easily remove the web app if we decide to
     implement the web interface externally to Django.

     | Path                 | Description                        |
     |----------------------+------------------------------------|
     | =.=                  | Repository root                    |
     | =¦-- web-app=        | Root of all the django code        |
     | =¦   ¦--qfieldcloud= | Django project                     |
     | =¦      ¦--model=    | Django app with the data model     |
     | =¦      ¦--api=      | Django app with the REST API views |
     | =¦      ¦--web=      | Django app with the web views      |
**** APIs
   The autogenerated REST API documentation is available on http://dev.qfield.cloud/swagger/
   A useful example on how to use the APIs is the [[https://github.com/opengisch/qfieldcloud/blob/master/web-app/qfieldcloud/apps/api/tests/test_functional.py][functional test]]
**** Data model
***** User
      Extends Django's AbstracUser
      | Name      | Type | Req. | Description                    |
      |-----------+------+------+--------------------------------|
      | user_type | int  | t    | Define if user or organization |
***** Organization
      Extends User
      | Name               | Type | Req. | Description |
      |--------------------+------+------+-------------|
      | organization_owner | FK   | t    | FK on User  |
***** Project
      A project represent the repository of the user's files
      A project can have only one QGIS project inside (qgs or qgz)

      | Name        | Type    | Req. | Description                                 |
      |-------------+---------+------+---------------------------------------------|
      | name        | string  | t    | name of the project                         |
      | description | string  |      | short description of the project            |
      | homepage    | string  |      | URL with more information about the project |
      | private     | boolean |      | Default: false                              |
      | owner       | FK      | t    | user / organization                         |
      | created_at  | date    | auto |                                             |
      | updated_ad  | date    | auto |                                             |
***** ProjectCollaborator
      | Name         | Type | Req. | Description   |
      |--------------+------+------+---------------|
      | project      | FK   | t    | FK on Project |
      | Collaborator | FK   | t    | FK on User    |
      | role         | int  | t    |               |

      A collaborator of an normal user project can only be reporter or
      reader. Editor or manager can only be set to an organization's project.
****** Roles
      A higher role always include also the lowest ones

      | Name     | Description                                                                                |
      |----------+--------------------------------------------------------------------------------------------|
      | admin    | The owner of a project is always admin of the project. He can add and remove collaborators |
      | manager  | Can add or remove collaborators                                                            |
      | editor   | Can edit data                                                                              |
      | reporter | Can only insert data (no update nor delete). (Don't have to be a collaborator?)            |
      | reader   | Can read data. (Don't have to be a collaborator?)                                          |
***** OrganizationMember
      | Name         | Type | Req. | Description |
      |--------------+------+------+-------------|
      | organization | FK   | t    | FK on User  |
      | member       | FK   | t    | FK on User  |
      | role         | int  | t    |             |
****** Roles
      A higher role always include also the lowest ones

      | Name    | Description                                                        |
      |---------+--------------------------------------------------------------------|
      | admin   | She can add and remove members and create project                  |
      | member  | (difference compared to an other user is for billing reasons only) |
***** File
      This represent the original file as seen by the client

      | Name          | Type   | Req. | Description                                  |
      |---------------+--------+------+----------------------------------------------|
      | project       | FK     | t    | FK on Project                                |
      | original_path | string | t    | absolute path of the file, filename included |
      | created_at    | date   | auto |                                              |
      | updated_at    | date   | auto |                                              |
***** FileVersion
      This represent the physical file versions stored on the file
      system

      | Name        | Type      | Req. | Description   |
      |-------------+-----------+------+---------------|
      | file        | FK        | t    | FK on File    |
      | stored_file | FileField | t    | physical file |
      | created_at  | date      | auto |               |
      | uploaded_by | FK        | t    | FK on User    |
**** Stored files
*** Tests
    To run all the unit and functional tests (on a throwaway test
    database and a throwaway test storage directory):
    #+begin_src sh
      docker-compose run web python manage.py test
    #+end_src
    
    To run only a test module (e.g. `test_permission.py`)
    #+begin_src sh
      docker-compose run web python manage.py test qfieldcloud.apps.api.test_permission
    #+end_src
*** Demo data
    Demo data are loaded with:
    #+begin_src sh
      python manage.py loaddata qfieldcloud/apps/model/fixtures/demo_data.json
    #+end_src

    Initial demo data:
    - superuser
      - username: demo_admin
      - password: demo_pwd
    - normal user
      - username: demo_user
      - password: demo_pwd
    - project
      - project name: demo_project
** Deployment
*** Servers
    QFieldCloud is published on two servers:
    - https://dev.qfield.cloud/ This is a testing instance for new
      features. Every push into master will be automatically deployed
      on this server via a Github workflow.
    - https://app.qfield.cloud/ This is the production instance. At
      the moment the deploy is done manually.

    On the "dev" server the `docker-compose.dev.yml` is used. On the
    "app" server, the `docker-compose.prod.yml` is used. On the
    servers there are no mounted folders. To apply changes, the docker
    image must be re-build.
*** Infrastructure
   Based on this example
   https://testdriven.io/blog/dockerizing-django-with-postgres-gunicorn-and-nginx/
** Resources
   - [[https://qfield.cloud][QField Cloud "marketing" page]]
   - [[https://app.qfield.cloud/swagger/][API Swagger doc]]
   - [[http://status.qfield.cloud/][API status page]]

